Got you. Here‚Äôs one single chunk you can paste into Replit as a BILL-style build prompt.

This assumes your repo already has the parcOS shell, Zustand store, CMFK, App Registry, BILL overlay, etc. The prompt tells Replit to add a hybrid spatial layer without wrecking the existing structure.

‚∏ª

üü£ BILL SPATIAL ENGINE PROMPT (HYBRID VISIONOS LAYER)

Paste everything below into Replit Agent:

‚∏ª

You are BILL, systems architect for parcOS.

The project already has a stable OS shell (cards, dock, SystemBar, BILL overlay, workspaces, CMFK, App Registry, engine files, etc.).
Your task is to add a hybrid spatial ‚ÄúVisionOS-like‚Äù environment on top of the existing structure without refactoring or breaking anything.

You MUST:
	‚Ä¢	Keep the current 2D React + Zustand + Framer Motion UI fully working.
	‚Ä¢	Add a 3D spatial layer behind/around it using React Three Fiber.
	‚Ä¢	Make the spatial layer aware of CMFK state so the world reflects Fog/Misconception/Knowingness.
	‚Ä¢	Keep changes modular and reversible (/spatial folder, minimal touchpoints).
	‚Ä¢	Respect file structure that already exists (detect root app entry and integrate cleanly).

Do NOT:
	‚Ä¢	Rewrite the window manager, store, or engine.
	‚Ä¢	Change existing public types/interfaces unless extending with optional fields.
	‚Ä¢	Introduce breaking changes to BILL commands or App Registry.

‚∏ª

1. Dependencies

First, ensure required dependencies are installed (skip if already present):
	‚Ä¢	three
	‚Ä¢	@react-three/fiber
	‚Ä¢	@react-three/drei
	‚Ä¢	@react-spring/three (for smooth camera/card motion)

Add them via package.json or install commands as appropriate for this Replit project.

‚∏ª

2. Create the Spatial Module

Create a new folder:
	‚Ä¢	client/src/spatial/ (or src/spatial/ depending on current structure)

Add the following files (adjust import paths based on detected root):
	1.	spatial/SpatialScene.tsx
	‚Ä¢	Exports a <SpatialScene /> component that renders a Three.js scene using <Canvas> from @react-three/fiber.
	‚Ä¢	Responsibilities:
	‚Ä¢	Set up camera: e.g. position={[0, 1.5, 3]}, fov={55}.
	‚Ä¢	Lighting: key light, fill light, and soft ambient.
	‚Ä¢	Background: gradient or environment map using Environment from @react-three/drei.
	‚Ä¢	Add a subtle fog or volumetric feel for depth.
	2.	spatial/BillOrb.tsx
	‚Ä¢	A small floating ‚ÄúBILL orb‚Äù mesh:
	‚Ä¢	sphereGeometry with emissive material.
	‚Ä¢	Idle pulsing animation using react-spring or frame-based updates.
	‚Ä¢	Positioned slightly above and in front of the user (e.g. [0, 1.4, -1]).
	‚Ä¢	Later, this can be hooked to voice/LLM events, but for now it should just visibly ‚Äúbreathe‚Äù.
	3.	spatial/SpatialDock.tsx
	‚Ä¢	A curved 3D bar that visually corresponds to the existing dock:
	‚Ä¢	Use a slightly curved plane mesh or a series of rounded boxes.
	‚Ä¢	Optionally place small icon placeholders as 3D meshes aligned with the existing DOM dock icons.
	‚Ä¢	This is visual only; DOM dock remains the interactive one.
	4.	spatial/WorkspaceRooms.tsx
	‚Ä¢	Defines logical ‚Äúrooms‚Äù in 3D associated with workspaces:
	‚Ä¢	SPORTS, NIL, CREATOR, SYSTEM, etc.
	‚Ä¢	Exports a component that:
	‚Ä¢	Reads activeWorkspace from the existing Zustand store.
	‚Ä¢	Animates the camera and/or room lighting slightly when the workspace changes.
	‚Ä¢	No UI logic changes, just camera/lighting changes.
	5.	spatial/useSpatialCamera.ts
	‚Ä¢	A hook that:
	‚Ä¢	Subscribes to Zustand for activeWorkspace.
	‚Ä¢	Controls the R3F camera (via useThree or useFrame) to smoothly move between workspace ‚Äúpositions‚Äù defined in a mapping, e.g.:

const workspacePositions: Record<string, [number, number, number]> = {
  SPORTS: [0, 1.5, 3],
  NIL: [3, 1.5, 3],
  CREATOR: [-3, 1.5, 3],
  SYSTEM: [0, 2, 5],
};


	‚Ä¢	Uses tweening/spring for smooth transitions.

‚∏ª

3. Wire CMFK Shape Engine to Spatial Effects

Locate the existing CMFK state/engine (e.g. state/cmfk.ts, cmfk-engine.ts, or similar).
Add a read-only selector hook for the global or dominant CMFK state:
	‚Ä¢	Either overall OS CMFK
	‚Ä¢	Or an aggregate of currently focused / active cards

Expose via Zustand:
	‚Ä¢	selectGlobalCmfk() or similar.

In /spatial/SpatialScene.tsx:
	‚Ä¢	Read CMFK values and map them to world parameters:
	‚Ä¢	Fog (F):
	‚Ä¢	Increase environmental fog density or haze as F increases.
	‚Ä¢	Misconception (M):
	‚Ä¢	Slightly warp or shake the background or add a subtle chromatic aberration effect.
	‚Ä¢	Knowingness (K):
	‚Ä¢	Increase overall brightness/intensity of key light as K rises.
	‚Ä¢	Correctness (C):
	‚Ä¢	Add a calm, stable ‚Äúglow‚Äù around the BILL orb or brighten a ‚Äúpath‚Äù in the scene.

Keep these effects subtle and non-distracting; they should feel like mood / ambience tied to the OS‚Äôs understanding.

‚∏ª

4. Integrate Spatial Layer with Existing App Root

Find the current React root, e.g.:
	‚Ä¢	client/src/main.tsx and client/src/App.tsx
	‚Ä¢	or similar entrypoint.

Modify the root so that:
	‚Ä¢	<SpatialScene /> is rendered underneath the existing 2D OS.
	‚Ä¢	The existing App (parcOS desktop, cards, dock, BILL overlay) renders on top using regular DOM.

Example structure (pseudo-code):

function Root() {
  return (
    <div className="parc-root">
      <div className="parc-spatial-layer">
        <SpatialScene />
      </div>
      <div className="parc-ui-layer">
        <App /> {/* existing parcOS UI */}
      </div>
    </div>
  );
}

Add CSS to ensure:
	‚Ä¢	Spatial layer covers full viewport and sits behind (z-index: 0).
	‚Ä¢	UI layer is on top (z-index: 10) and pointer events are not blocked.

Ensure the 3D canvas is positioned absolutely/fixed, full screen, no scrollbars.

‚∏ª

5. Add Parallax + Tilt to Existing Cards (2.5D Effect)

Without changing the card logic, upgrade the card component (e.g. ParcCard, CardWindow, or equivalent) so that:
	‚Ä¢	It reacts to pointer or cursor position with a slight tilt and parallax:
	‚Ä¢	Use Framer Motion or CSS transforms:
	‚Ä¢	rotateX, rotateY, and small translateZ/scale.
	‚Ä¢	Constrain the max tilt to something gentle (e.g. 8‚Äì10 degrees).
	‚Ä¢	Optionally, use the lane (focus/work/archive) or CMFK state to modulate depth:
	‚Ä¢	Focus lane ‚Üí stronger parallax, brighter shadow.
	‚Ä¢	Archive lane ‚Üí flatter, dimmer.

This keeps all interactions DOM-based but makes the OS feel spatially alive and VisionOS-like.

‚∏ª

6. Add a Toggle and Settings Hook (Non-Destructive)

Add a simple feature flag in the Zustand store, e.g.:

spatialEnabled: true;
toggleSpatial(): void;

Wire it to:
	‚Ä¢	A small control in SystemBar (e.g. ‚ÄúSpatial: On/Off‚Äù) for debugging.
	‚Ä¢	When disabled, don‚Äôt render <SpatialScene /> to save GPU/battery.

This ensures the spatial features are optional and safe.

‚∏ª

7. Testing and Verification

Implement/check the following:
	1.	App builds and runs without TypeScript errors.
	2.	Existing 2D parcOS behavior remains unchanged:
	‚Ä¢	Dock icons still launch apps.
	‚Ä¢	BILL overlay still toggles.
	‚Ä¢	Cards still drag, resize, minimize, and snap correctly.
	3.	Spatial layer:
	‚Ä¢	3D scene visible behind OS.
	‚Ä¢	BILL orb floating and pulsing.
	‚Ä¢	Camera moves when activeWorkspace changes.
	4.	CMFK integration:
	‚Ä¢	Changing CMFK values (simulate via a dev command) visibly alters scene ambience (fog/brightness/orb intensity).
	5.	Spatial toggle:
	‚Ä¢	Turning spatial off completely removes the 3D canvas without breaking UI.

Document in a short comment block at the top of SpatialScene.tsx how to extend the spatial behavior in the future (e.g. 3D windows, cinema room, etc.).

‚∏ª

8. Constraints and Style
	‚Ä¢	Use TypeScript throughout.
	‚Ä¢	Keep all new types and hooks in /spatial or existing /state folders as appropriate.
	‚Ä¢	No intrusive changes to engine, App Registry, or BILL commands‚Äîonly read from them.
	‚Ä¢	Maintain the current visual style (dark mode, glassmorphism).
	‚Ä¢	Prefer small, composable components over one giant file.

‚∏ª

End of instructions.

Execute this plan and then summarize:
	1.	Files created/modified.
	2.	How to enable/disable the spatial layer.
	3.	How CMFK currently influences the 3D world.
	4.	Any recommendations for future ‚Äúfull 3D window‚Äù evolution.